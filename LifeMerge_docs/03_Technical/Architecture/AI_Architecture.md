# AI Architecture

## Сервисы
- **AI Planner API:** принимает профиль пользователя, цели, занятость календаря, предпочтения энергии/фокуса, возвращает план недели.
- **Insights:** генерирует текстовые резюме недели/финансов, теги для задач и целей.
- **Safety Layer:** проверка токенов, лимиты на объём текста, фильтрация запрещённого контента.

## Поток планирования
1. Backend собирает контекст (цели, задачи, события, предпочтения) и отправляет в AI сервис.
2. AI сервис вызывает LLM (внешний провайдер), применяет промпт-шаблоны и пост-обработку (нормализация дат, ограничения бюджета времени).
3. Результат сохраняется в БД через backend (`ai_plans` + связанные задачи/события), пользователю показывается diff.

## Технические детали
- Реализация на Python/Node, контейнер; запросы через REST `/v1/plan`, `/v1/summary`.
- Асинхронная обработка через очередь; синхронный ответ только для быстрых подсказок (<3 сек).
- Логирование запросов обезличено (hash user_id), содержимое подсказок хранится в зашифрованном виде.
- Версионирование промптов и моделей (`model_version`, `prompt_version`) для сравнения качества.

## Качество и безопасное использование
- Метрики: время отклика, % успешных планов, % ручных правок пользователем, жалобы на качество.
- A/B: сравнение разных промптов/моделей на когортах stage/prod.
- Fallback: при недоступности LLM — базовый план на шаблонах (распределение задач по приоритету и сроку).
