# Offline Sync Design

## Цели
- Позволить создавать/редактировать задачи, события, финоперации без сети.
- Избежать потери данных и дублей при восстановлении соединения.

## Локальные данные
- Храним в `sqflite` таблицы `tasks_local`, `events_local`, `transactions_local`, `pending_operations`.
- Каждая запись содержит `local_id`, `server_id`, `updated_at_local`, `updated_at_server`, `sync_status`.

## Очередь операций
- Формат операции: `{type, entity, payload, request_id, created_at}`.
- Синхронизатор отправляет батчами (до 20 операций) в `/sync/batch` или соответствующие модули.
- В случае конфликта сервер возвращает 409 с актуальной версией; клиент показывает diff.

## Политики конфликта
- **Last Write Wins** по `updated_at`, но если разница >24h, показываем выбор пользователю.
- Удаления помечаются `deleted=true` и синхронизируются как soft delete.

## Дополнительное
- Фоновая синхронизация при смене сети или раз в 15 минут на фоне.
- При logout очищаем локальные таблицы и pending-очередь.
- Журналируем ошибки синка и отправляем в Sentry.
