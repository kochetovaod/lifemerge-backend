# Authentication & Authorization

## Флоу входа
1. Пользователь вводит email/пароль → `/auth/login`.
2. Backend возвращает `access_token` (15–30 мин), `refresh_token` (30 дней), `user_profile`.
3. Access хранится в памяти клиента, refresh — в защищённом хранилище (Keychain/Keystore).
4. При истечении access вызываем `/auth/refresh` с `refresh_token`.

## Регистрация и восстановление
- Signup: email + пароль + согласие с политиками; письмо для верификации.
- Восстановление пароля: одноразовый код/ссылка, ограничения по частоте (5 запросов/час).
- Ограничение устройств: по умолчанию до 3 активных refresh-токенов; `logout_all` отзывает остальные.

## Авторизация
- Роли: `user` (по умолчанию), `admin`, `support` (read-only). Проверка ролей в middleware.
- Доступ к объектам проверяем по `user_id` + флагам доступа (для будущего шеринг-модуля).
- Для AI-вызовов добавляем доп. лимиты и контроль объёма входного текста.

## Безопасность токенов
- Формат JWT: `sub`, `role`, `exp`, `iat`, `device_id`.
- Подпись: RS256, приватный ключ в KMS. Ключи ротируются каждые 90 дней, `kid` в заголовке.
- Чёрный список refresh-токенов в Redis/PostgreSQL (`revoked_tokens`).

## Аудит
- Логируем входы/выходы, смену пароля, подозрительные IP/гео, попытки доступа к чужим ресурсам.
- Пользователь может просмотреть последние активные сессии и отозвать их.
